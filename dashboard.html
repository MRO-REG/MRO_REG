<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard VLT Carioca</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --light: #f5f7fa;
            --dark: #2c3e50;
            --border: #e0e6ed;
            --success: #4facfe;
            --danger: #f5576c;
            --warning: #ffa726;
            --info: #29b6f6;
            --azul-linha: #0055A4;
            --verde-linha: #00A651;
            --amarelo-linha: #FFC400;
            --laranja-linha: #F37335;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            position: relative;
            overflow: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://www.transparenttextures.com/patterns/cubes.png'), linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            z-index: -1;
        }
        .container { display: flex; height: 100vh; }
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px 20px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: width 0.3s ease;
            position: relative;
            z-index: 100;
        }
        .sidebar.collapsed { width: 80px; padding: 20px 10px; }
        .sidebar.collapsed .nav-label, .sidebar.collapsed .logo span { display: none; }
        .sidebar.collapsed .nav-item { justify-content: center; }
        .toggle-sidebar {
            position: absolute;
            top: 30px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.3s;
        }
        .sidebar.collapsed .toggle-sidebar { transform: rotate(180deg); }
        .logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo i { font-size: 32px; color: var(--primary); }
        .nav-menu { list-style: none; }
        .nav-item {
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 6px;
            cursor: pointer;
            color: rgba(255,255,255,0.7);
            transition: all 0.3s;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .nav-item:hover, .nav-item.active {
            background: rgba(102,126,234,0.2);
            color: white;
            border-left-color: var(--primary);
        }
        .nav-item i { width: 20px; min-width: 20px; }
        .nav-label { display: inline; }
        .nav-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 20px 0; }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .breadcrumb { color: var(--dark); font-size: 16px; font-weight: 600; }
        .top-right { display: flex; gap: 20px; align-items: center; }
        .screenshot-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .screenshot-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.3s;
        }
        .user-profile:hover { background: var(--light); }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .user-info { font-size: 13px; }
        .user-name { font-weight: 600; color: var(--dark); }
        .user-role { color: #7f8c8d; font-size: 11px; }
        .content { flex: 1; overflow-y: auto; padding: 30px; position: relative; display: flex; flex-direction: column; }
        .pages-wrapper { flex: 1; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { margin-bottom: 30px; }
        .page-header h1 { font-size: 28px; color: var(--dark); margin-bottom: 5px; }
        .page-header p { color: var(--dark); font-size: 14px; font-weight: 500; }
        /* Loading */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            border-radius: 8px;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            border: 5px solid var(--border);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Filtros Relat√≥rios */
        .filter-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-input, .filter-select {
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: white;
        }
        .filter-input:focus, .filter-select:focus { outline: none; border-color: var(--primary); }
        .filter-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
            transition: all 0.3s;
        }
        .filter-btn:hover, .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        /* Tabelas */
        .table-container { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 8px; overflow-x: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; font-size:13px; }
        thead { background: var(--light); }
        th { padding: 15px; text-align: left; font-weight: 600; color: var(--dark); border-bottom: 2px solid var(--border); }
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); }
        tr:hover { background: var(--light); }
        /* Bot√µes */
        .btn-primary {
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary i { margin-right: 8px; }
        .center-content { text-align: center; padding: 60px 20px; }
        /* Modais */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal.show { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #bdc3c7;
            transition: color 0.3s;
        }
        .modal-close:hover { color: var(--dark); }
        .modal-title { font-size: 24px; font-weight: 600; margin-bottom: 30px; color: var(--dark); }
        .modal-section { margin-bottom: 25px; }
        .modal-label { font-size: 12px; color: #7f8c8d; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
        .modal-value { font-size: 16px; color: var(--dark); font-weight: 600; }
        .modal-link { display: inline-block; color: var(--primary); text-decoration: none; cursor: pointer; font-weight: 600; }
        .modal-link:hover { color: var(--secondary); }
        /* Aba Sobre VLT */
        .sobre-container { display: flex; gap: 30px; }
        .sobre-map { flex: 1; }
        .sobre-map img { width: 100%; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .sobre-info { flex: 1; }
        .info-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .info-card h3 { color: var(--dark); margin-bottom: 15px; }
        .info-card p { color: #555; line-height: 1.6; }
        .search-box { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 6px; font-size: 14px; margin-bottom: 20px; }
        .linha-btn { padding: 10px 15px; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; margin: 5px; transition: transform 0.2s; }
        .linha-btn:hover { transform: scale(1.05); }
        .linha-azul { background-color: var(--azul-linha); }
        .linha-verde { background-color: var(--verde-linha); }
        .linha-amarela { background-color: var(--amarelo-linha); }
        .linha-laranja { background-color: var(--laranja-linha); }
        .estacoes-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; padding: 10px; }
        .estacao-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .estacao-item:hover { background: var(--light); }
        .estacao-item.highlight { background: #fff3cd; font-weight: bold; }
        /* Rel√≥gio de Opera√ß√£o */
        .operation-clock {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .operation-clock h2 { font-size: 20px; margin-bottom: 10px; font-weight: 700; }
        .clock-display { font-size: 28px; font-weight: 700; font-family: 'Courier New', Courier, monospace; }
        .clock-display span { margin: 0 5px; }
        /* Resumo Passagem - REMOVIDO conforme solicitado */
        .resumo-passagem { display: none; }
        .motivational-quote {
            margin-top: auto;
            padding-top: 30px;
            border-top: 2px solid var(--border);
            text-align: center;
            color: var(--dark);
            font-style: italic;
            font-size: 16px;
            font-weight: 600;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
        }
        .loading { color: var(--primary); }
        /* Estilos para Documenta√ß√£o */
        .documents-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .document-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
            cursor: pointer;
        }
        .document-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .document-icon {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        .document-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .document-info {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        .document-actions {
            display: flex;
            gap: 10px;
        }
        .document-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }
        .document-btn.view {
            background: var(--primary);
            color: white;
        }
        .document-btn.download {
            background: var(--success);
            color: white;
        }
        .document-btn:hover {
            transform: translateY(-2px);
        }
        /* Estilos para formul√°rios embutidos */
        .form-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            position: relative;
            min-height: 850px;
        }
        .form-iframe {
            width: 100%;
            height: 800px;
            border: none;
            display: block;
        }
        .tabs-container {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 0;
        }
        .tab-btn {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
            transition: all 0.3s;
            flex: 1;
        }
        .tab-btn.active {
            background: white;
            border-bottom-color: var(--primary);
            color: var(--primary);
        }
        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .tab-content.active {
            display: block;
        }
        @media (max-width: 768px) {
            .top-bar { padding: 12px 15px; }
            .screenshot-btn { padding: 6px 12px; font-size: 12px; }
            .user-info { display: none; }
            .content { padding: 15px; }
            .page-header h1 { font-size: 20px; }
            .filter-container { flex-direction: column; }
            .filter-btn { width: 100%; }
            .sobre-container { flex-direction: column; }
            .documents-container { grid-template-columns: 1fr; }
            .form-iframe { height: 600px; }
        }
        /* Fallback para quando o iframe √© bloqueado */
        .fallback-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            color: var(--dark);
        }
        .fallback-message {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        .fallback-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .fallback-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        .fallback-btn i {
            font-size: 18px;
        }
            /* Estilos para a aba Cat√°logo */
        .catalogo-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 25px;
    height: calc(100% - 80px); /* Ajusta para o espa√ßo do header */
        }
        .catalogo-column {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .column-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-container {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            gap: 10px;
        }
        .search-container input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }
        .search-container button {
            padding: 10px 15px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .search-container button:hover {
            background: #e74c3c;
        }
        .tree-container, .materiais-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .tree-container {
            font-size: 14px;
        }
        .materiais-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            align-content: start;
        }
        .material-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        .material-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }
        .material-card h4 {
            margin: 0 0 10px 0;
            color: var(--dark);
            font-size: 16px;
        }
        .material-card p {
            margin: 0;
            color: #555;
            font-size: 13px;
        }
        .material-card .material-id {
            font-weight: bold;
            color: var(--primary);
        }
        /* Estilos da √Årvore (reaproveitados e adaptados) */
        .tree-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .tree-item:hover {
            background-color: var(--light);
        }
        .tree-item.selected {
            background-color: #fff3e0;
            border-left: 3px solid var(--primary);
        }
        .tree-item .toggle-btn {
            min-width: 20px;
            height: 20px;
            line-height: 18px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            background: #FF7C3C;
            color: white;
            font-size: 12px;
        }
        .tree-item .toggle-placeholder {
            min-width: 20px;
        }
        .tree-item .view-btn {
            padding: 2px 8px;
            background-color: #004680;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .tree-item ul {
            list-style-type: none;
            padding-left: 25px;
            margin: 0;
            position: relative;
        }
        .tree-item ul:before {
            content: '';
            position: absolute;
            top: 0;
            left: 8px;
            bottom: 0;
            width: 1px;
            background: #ccc;
        }
        .tree-item li {
            margin: 5px 0;
            position: relative;
        }
        .tree-item li:before {
            content: '';
            position: absolute;
            top: 12px;
            left: -17px;
            width: 17px;
            height: 1px;
            background: #ccc;
        }
        /* Estilos do Modal (reaproveitados) */
        #itemDetailsModal .modal-content {
             max-width: 900px;
             width: 95%;
             max-height: 90vh;
        }
        #itemDetailsModal .modal-body {
             padding: 0;
             max-height: calc(90vh - 70px);
             overflow: hidden;
        }
        .modal-tabs {
             display: flex;
             background: var(--light);
             border-bottom: 1px solid var(--border);
        }
        .modal-tab-btn {
             flex: 1;
             padding: 15px;
             background: none;
             border: none;
             cursor: pointer;
             font-size: 16px;
             font-weight: 600;
             color: var(--dark);
             transition: all 0.3s;
        }
        .modal-tab-btn.active {
             background: white;
             color: var(--primary);
             border-bottom: 3px solid var(--primary);
        }
        .modal-tab-content {
             padding: 20px;
             overflow-y: auto;
             max-height: calc(90vh - 180px);
             background: white;
        }
        .image-gallery {
             display: flex;
             gap: 15px;
             flex-wrap: wrap;
             justify-content: center;
        }
        .image-gallery img {
             max-width: 100%;
             max-height: 300px;
             border-radius: 8px;
             box-shadow: 0 4px 10px rgba(0,0,0,0.1);
             object-fit: contain;
        }
        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--primary);
            font-size: 18px;
        }
        .loading-spinner i {
            font-size: 30px;
            margin-bottom: 15px;
        }
        /* Destaque para busca */
        .highlight {
            background-color: #fff59d;
            padding: 0 2px;
            border-radius: 2px;
        }
        /* Responsividade */
        @media (max-width: 1024px) {
            .catalogo-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <button class="toggle-sidebar" onclick="toggleSidebar()">‚óÄ</button>
            <div class="logo">
                <i class="fas fa-train"></i>
                <span>VLT Carioca</span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" onclick="showPage('dashboard', event)">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-label">Dashboard</span>
                </li>
                <li class="nav-item" onclick="showPage('plantao', event)">
                <i class="fas fa-clock"></i>
                <span class="nav-label">Plant√£o</span>
                </li>
                <li class="nav-item" onclick="showPage('passagem', event)">
                    <i class="fas fa-clipboard-list"></i>
                    <span class="nav-label">Passagem de Servi√ßo</span>
                </li>
                <li class="nav-item" onclick="showPage('novo_registro', event)">
                    <i class="fas fa-plus-circle"></i>
                    <span class="nav-label">Novo Registro</span>
                </li>
        
                <li class="nav-item" onclick="showPage('usuarios', event)" id="usuarios-menu">
                    <i class="fas fa-users"></i>
                    <span class="nav-label">Usu√°rios</span>
                </li>
                <li class="nav-item" onclick="showPage('laboratorio', event)">
                    <i class="fas fa-flask"></i>
                    <span class="nav-label">Laborat√≥rio</span>
                </li>
                <li class="nav-item" onclick="showPage('eva', event)">
                    <i class="fas fa-robot"></i>
                    <span class="nav-label">EVA</span>
                </li>
                <li class="nav-item" onclick="showPage('refrigeracao', event)">
                    <i class="fas fa-snowflake"></i>
                    <span class="nav-label">Refrigera√ß√£o</span>
                </li>
                <li class="nav-item" onclick="showPage('rastreabilidade', event)">
                    <i class="fas fa-route"></i>
                    <span class="nav-label">Rastreabilidade</span>
                </li>
                <li class="nav-item" onclick="showPage('documentacao', event)">
                    <i class="fas fa-book"></i>
                    <span class="nav-label">Documenta√ß√£o</span>
                </li>
                <li class="nav-item" onclick="showPage('catalogo', event)">
                    <i class="fas fa-book-open"></i>
                    <span class="nav-label">Cat√°logo</span>
                </li>
                <!-- Cole este item dentro da <ul class="nav-menu"> -->
<li class="nav-item" onclick="showPage('programacao', event)">
    <i class="fas fa-calendar-alt"></i>
    <span class="nav-label">Programa√ß√£o</span>
</li>
<li class="nav-item" onclick="showPage('plano_frota', event)">
    <i class="fas fa-train"></i>
    <span class="nav-label">Plano de Frota</span>
</li>
                <li class="nav-item" onclick="showPage('sobre', event)">
                    <i class="fas fa-info-circle"></i>
                    <span class="nav-label">Sobre o VLT</span>
                </li>
                <li class="nav-item" onclick="openSupportModal()">
                    <i class="fas fa-headset"></i>
                    <span class="nav-label">Suporte</span>
                </li>
            </ul>
        </aside>
        <main class="main">
            <div class="top-bar">
                <div class="breadcrumb" id="breadcrumb">üìä Dashboard</div>
                <div class="top-right">
                    <button class="screenshot-btn" id="screenshotBtn" style="display:none;" onclick="takeScreenshot()">
                        <i class="fas fa-camera"></i> Screenshot
                    </button>
                    <div class="user-profile" onclick="openProfileModal()">
                        <div class="user-avatar" id="userInitials">GJ</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Carregando...</div>
                            <div class="user-role" id="userRole">...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content">
                <div class="pages-wrapper">
                    <!-- Dashboard -->
                    <div class="page active" id="page-dashboard">
                        <div class="cards-container" id="dashboard-cards"></div>
                        <div style="width: 100%; height: 600px; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; position: relative;">
                            <div class="loading-overlay" id="loading-looker">
                                <div class="spinner"></div>
                            </div>
                            <iframe src="https://lookerstudio.google.com/embed/reporting/95cf4b2a-b4ef-4aa1-910c-423461799e6c" frameborder="0" style="border: 0; width: 100%; height: 100%;" onload="document.getElementById('loading-looker').classList.add('hidden')" allowfullscreen="" aria-hidden="false" tabindex="0"></iframe>
                        </div>
                    </div>
                    <!-- Plant√£o -->
                    <div class="page" id="page-plantao">
                        <div class="page-header">
                            <h1>üïí Plant√£o</h1>
                            <p>Visualize a escala de trabalho por data. <strong>Base: 24/12/2025 (quarta-feira)</strong>.</p>
                        </div>
                        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <button class="btn-primary" onclick="plantaoHoje()">
                                <i class="fas fa-calendar-day"></i> Hoje
                            </button>
                            <input type="month" id="mes-plantao" class="filter-input" value="2025-12" onchange="atualizarCalendarioPlantao()">
                            <button class="btn-primary" onclick="mudarMesPlantao(-1)">
                                <i class="fas fa-chevron-left"></i> Anterior
                            </button>
                            <button class="btn-primary" onclick="mudarMesPlantao(1)">
                                Pr√≥ximo <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="table-container">
                            <div id="calendario-plantao" style="padding: 20px; min-height: 500px; display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px;">
                                <div style="text-align: center; font-weight: bold; padding: 10px; background: var(--light);">Dom</div>
                                <div style="text-align: center; font-weight: bold; padding: 10px; background: var(--light);">Seg</div>
                                <div style="text-align: center; font-weight: bold; padding: 10px; background: var(--light);">Ter</div>
                                <div style="text-align: center; font-weight: bold; padding: 10px; background: var(--light);">Qua</div>
                                <div style="text-align: center; font-weight: bold; padding: 10px; background: var(--light);">Qui</div>
                                <div style="text-align: center; font-weight: bold; padding: 10px; background: var(--light);">Sex</div>
                                <div style="text-align: center; font-weight: bold; padding: 10px; background: var(--light);">S√°b</div>
                                <!-- Dias ser√£o preenchidos automaticamente -->
                            </div>
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.95); border-radius: 8px; border-left: 4px solid var(--primary);">
                            <h3 style="margin-bottom: 10px; color: var(--dark);">üéØ Legenda da Escala 2√ó2</h3>
                            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                                <div style="flex: 1; padding: 10px; background: #E8F5E9; border-radius: 6px; border: 2px solid #4CAF50;">
                                    <strong>üü¢ Dias Verdes</strong>
                                    <div style="font-size: 12px; color: #555;">
                                        ‚òÄÔ∏è <strong>Grupo B</strong> trabalha<br>
                                        üåô <strong>Grupo C</strong> trabalha<br>
                                        ‚ûñ Grupos A e D folgam
                                    </div>
                                </div>
                                <div style="flex: 1; padding: 10px; background: #FFFEF2; border-radius: 6px; border: 2px solid #FFD54F;">
                                    <strong>üü° Dias Amarelos</strong>
                                    <div style="font-size: 12px; color: #555;">
                                        ‚òÄÔ∏è <strong>Grupo A</strong> trabalha<br>
                                        üåô <strong>Grupo D</strong> trabalha<br>
                                        ‚ûñ Grupos B e C folgam
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Passagem de Servi√ßo (VERS√ÉO CORRIGIDA) -->
                    <div class="page" id="page-passagem">
                        <div class="page-header">
                            <h1>üìã Passagem de Servi√ßo</h1>
                            <p>Resumo do plant√£o. Use o filtro para carregar os dados corretos.</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <button class="btn-primary" onclick="openPassagemFilterModal()">
                                <i class="fas fa-filter"></i> Filtrar Passagem de Servi√ßo
                            </button>
                            <a href="https://docs.google.com/spreadsheets/d/13G8eUT2m35aoWsqpIu3OTKUdg0L2sdjEl0GTXfPEg50/edit?usp=sharing" target="_blank" class="btn-primary" style="margin-left: 10px;">
                                <i class="fas fa-table"></i> Acessar Planilha
                            </a>
                            <button class="btn-primary" onclick="takePassagemScreenshot()" style="margin-left: 10px;">
                                <i class="fas fa-camera"></i> Capturar Tela
                            </button>
                        </div>
                        <div class="filter-container" id="passagem-filters" style="display: none;">
                            <input type="date" id="passagemData" class="filter-input" placeholder="Selecione a data">
                            <select id="passagemGrupo" class="filter-select">
                                <option value="">Todos Grupos</option>
                                <option value="GRUPO A">GRUPO A</option>
                                <option value="GRUPO B">GRUPO B</option>
                                <option value="GRUPO C">GRUPO C</option>
                                <option value="GRUPO D">GRUPO D</option>
                            </select>
                            <input type="text" id="passagemTrem" class="filter-input" placeholder="N√∫mero do Trem">
                            <input type="text" id="passagemSistema" class="filter-input" placeholder="Sistema">
                            <input type="text" id="passagemTecnico" class="filter-input" placeholder="T√©cnico">
                            <select id="passagemStatus" class="filter-select">
                                <option value="">Todos Status</option>
                                <option value="LIBERADO">LIBERADO</option>
                                <option value="MANUTEN√á√ÉO">MANUTEN√á√ÉO</option>
                                <option value="AGENDADO">AGENDADO</option>
                                <option value="COLIS√ÉO">COLIS√ÉO</option>
                                <option value="PREVENTIVA">PREVENTIVA</option>
                            </select>
                            <button class="filter-btn" onclick="applyPassagemFilters()">
                                <i class="fas fa-filter"></i> Aplicar Filtros
                            </button>
                            <button class="filter-btn" onclick="clearPassagemFilters()">
                                <i class="fas fa-times"></i> Limpar
                            </button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>T√©cnico</th>
                                        <th>Trem</th>
                                        <th>Sistema</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="passagem-table">
                                    <tr><td colspan="7" style="text-align: center; padding: 40px;">Clique no bot√£o "Filtrar Passagem de Servi√ßo" para carregar os dados.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Novo Registro -->
                    <div class="page" id="page-novo_registro">
                        <div class="page-header">
                            <h1>‚ûï Novo Registro</h1>
                            <p>Registre uma nova falha ou evento no sistema</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTI602SZCvv3Vljbau78ZXFxNxUVQATWF1aefTd0rxh6zXpmhV9nDjmpimnDO5vkHLKpWZl82Kw4Gu2/pub?gid=195449004&single=true&output=csv" target="_blank" class="btn-primary">
                                <i class="fas fa-table"></i> Acessar Planilha
                            </a>
                            <button class="btn-primary" onclick="takePageScreenshot('novo_registro')" style="margin-left: 10px;">
                                <i class="fas fa-camera"></i> Capturar Tela
                            </button>
                        </div>
                        <div class="form-container">
                            <div class="loading-overlay" id="loading-novo_registro">
                                <div class="spinner"></div>
                            </div>
                            <iframe 
                                src="https://docs.google.com/forms/d/e/1FAIpQLSdz056J8dsQMPXV6__U2B-VOxQEaNF34bwyaRgFVlcCKOLZ_Q/viewform?embedded=true" 
                                class="form-iframe"
                                allow="clipboard-read; clipboard-write"
                                allowfullscreen
                                loading="lazy"
                                onload="handleIframeLoad('loading-novo_registro')"
                                onerror="handleIframeError('page-novo_registro', 'https://docs.google.com/forms/d/e/1FAIpQLSdz056J8dsQMPXV6__U2B-VOxQEaNF34bwyaRgFVlcCKOLZ_Q/viewform')"
                            ></iframe>
                        </div>
                    </div>
                    <!-- Relat√≥rios -->
                    <div class="page" id="page-relatorios">
                        <div class="page-header">
                            <h1>üìä Relat√≥rios de Falhas</h1>
                            <p>Filtre e exporte os dados conforme sua necessidade</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTI602SZCvv3Vljbau78ZXFxNxUVQATWF1aefTd0rxh6zXpmhV9nDjmpimnDO5vkHLKpWZl82Kw4Gu2/pub?gid=195449004&single=true&output=csv" target="_blank" class="btn-primary">
                                <i class="fas fa-table"></i> Acessar Planilha
                            </a>
                            <button class="btn-primary" onclick="takePageScreenshot('relatorios')" style="margin-left: 10px;">
                                <i class="fas fa-camera"></i> Capturar Tela
                            </button>
                        </div>
                        <div class="filter-container">
                            <input type="date" id="filterDataInicio" class="filter-input" placeholder="Data In√≠cio">
                            <input type="date" id="filterDataFim" class="filter-input" placeholder="Data Fim">
                            <input type="text" id="filterTrem" class="filter-input" placeholder="N√∫mero do Trem (ex: VLT 101)">
                            <input type="text" id="filterSistema" class="filter-input" placeholder="Sistema (ex: Tra√ß√£o)">
                            <input type="text" id="filterEquipe" class="filter-input" placeholder="Equipe (A, B, C, D)">
                            <input type="text" id="filterTecnico" class="filter-input" placeholder="T√©cnico">
                            <input type="text" id="filterIOS" class="filter-input" placeholder="C√≥digo IOS">
                            <select id="filterStatus" class="filter-select">
                                <option value="">Todos Status</option>
                                <option value="LIBERADO">LIBERADO</option>
                                <option value="MANUTEN√á√ÉO">MANUTEN√á√ÉO</option>
                                <option value="AGENDADO">AGENDADO</option>
                                <option value="COLIS√ÉO">COLIS√ÉO</option>
                                <option value="PREVENTIVA">PREVENTIVA</option>
                            </select>
                            <button class="filter-btn" onclick="applyFilters()">
                                <i class="fas fa-filter"></i> Aplicar Filtros
                            </button>
                            <button class="filter-btn" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Limpar
                            </button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>T√©cnico</th>
                                        <th>Trem</th>
                                        <th>Sistema</th>
                                        <th>IOS</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="relatorio-table">
                                    <tr><td colspan="8" style="text-align:center;padding:40px;">Clique em "Aplicar Filtros" para gerar o relat√≥rio</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="download-buttons" id="download-buttons" style="display: none; gap: 10px; margin-top: 20px;">
                            <button class="btn-primary" onclick="downloadCSV()">
                                <i class="fas fa-file-excel"></i> Download Excel (CSV)
                            </button>
                            <button class="btn-primary" onclick="downloadPDF()">
                                <i class="fas fa-file-pdf"></i> Download PDF
                            </button>
                        </div>
                    </div>
                    <!-- Usu√°rios -->
                    <div class="page" id="page-usuarios">
                        <div class="page-header">
                            <h1>üë• Usu√°rios do Sistema</h1>
                            <p>Lista de usu√°rios cadastrados e seus perfis</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQh0a-BMomvvOomRWYGlmoZSPG6ZuwF1jRXFrm8yhzMzizB9vWBgFiFBRyFBRRHQfVVoRppT3E8FBKS/pubhtml?gid=150830072&single=true" target="_blank" class="btn-primary">
                                <i class="fas fa-table"></i> Acessar Planilha
                            </a>
                            <button class="btn-primary" onclick="takePageScreenshot('usuarios')" style="margin-left: 10px;">
                                <i class="fas fa-camera"></i> Capturar Tela
                            </button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Usu√°rio</th>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>Telefone</th>
                                        <th>Tipo</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="usuarios-table">
                                    <tr><td colspan="7" style="text-align: center; padding: 40px;" class="loading">‚è≥ Carregando usu√°rios...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Laborat√≥rio -->
                    <div class="page" id="page-laboratorio">
                        <div class="page-header">
                            <h1>üî¨ Laborat√≥rio</h1>
                            <p>Registros e atividades da equipe de laborat√≥rio</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQh0a-BMomvvOomRWYGlmoZSPG6ZuwF1jRXFrm8yhzMzizB9vWBgFiFBRyFBRRHQfVVoRppT3E8FBKS/pubhtml?gid=43329994&single=true" target="_blank" class="btn-primary">
                                <i class="fas fa-table"></i> Acessar Planilha
                            </a>
                            <button class="btn-primary" onclick="takePageScreenshot('laboratorio')" style="margin-left: 10px;">
                                <i class="fas fa-camera"></i> Capturar Tela
                            </button>
                        </div>
                        <div class="form-container">
                            <div class="loading-overlay" id="loading-laboratorio">
                                <div class="spinner"></div>
                            </div>
                            <iframe 
                                src="https://docs.google.com/forms/d/e/1FAIpQLSeX0zKXBJXX3SyCkJGHufqbEDlTnpRigdZq0TmBqdLmC3woGQ/viewform?embedded=true" 
                                class="form-iframe"
                                allow="clipboard-read; clipboard-write"
                                allowfullscreen
                                loading="lazy"
                                onload="handleIframeLoad('loading-laboratorio')"
                                onerror="handleIframeError('page-laboratorio', 'https://docs.google.com/forms/d/e/1FAIpQLSeX0zKXBJXX3SyCkJGHufqbEDlTnpRigdZq0TmBqdLmC3woGQ/viewform')"
                            ></iframe>
                        </div>
                    </div>
                    <!-- EVA -->
                    <div class="page" id="page-eva">
                        <div class="page-header">
                            <h1>ü§ñ EVA</h1>
                            <p>Registros e atividades da equipe EVA</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQh0a-BMomvvOomRWYGlmoZSPG6ZuwF1jRXFrm8yhzMzizB9vWBgFiFBRyFBRRHQfVVoRppT3E8FBKS/pubhtml?gid=927195938&single=true" target="_blank" class="btn-primary">
                                <i class="fas fa-table"></i> Acessar Planilha
                            </a>
                            <button class="btn-primary" onclick="takePageScreenshot('eva')" style="margin-left: 10px;">
                                <i class="fas fa-camera"></i> Capturar Tela
                            </button>
                        </div>
                        <div class="form-container">
                            <div class="loading-overlay" id="loading-eva">
                                <div class="spinner"></div>
                            </div>
                            <iframe 
                                src="https://docs.google.com/forms/d/e/1FAIpQLSeixWIcnMdFmqHnxwO-vb2F86AKW6g6KRqDwMsYTk3Baj6l8w/viewform?embedded=true" 
                                class="form-iframe"
                                allow="clipboard-read; clipboard-write"
                                allowfullscreen
                                loading="lazy"
                                onload="handleIframeLoad('loading-eva')"
                                onerror="handleIframeError('page-eva', 'https://docs.google.com/forms/d/e/1FAIpQLSeixWIcnMdFmqHnxwO-vb2F86AKW6g6KRqDwMsYTk3Baj6l8w/viewform')"
                            ></iframe>
                        </div>
                    </div>
                    <!-- Refrigera√ß√£o -->
                    <div class="page" id="page-refrigeracao">
                        <div class="page-header">
                            <h1>‚ùÑÔ∏è Refrigera√ß√£o</h1>
                            <p>Registros e atividades da equipe de refrigera√ß√£o</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQh0a-BMomvvOomRWYGlmoZSPG6ZuwF1jRXFrm8yhzMzizB9vWBgFiFBRyFBRRHQfVVoRppT3E8FBKS/pubhtml?gid=131107120&single=true" target="_blank" class="btn-primary">
                                <i class="fas fa-table"></i> Acessar Planilha
                            </a>
                            <button class="btn-primary" onclick="takePageScreenshot('refrigeracao')" style="margin-left: 10px;">
                                <i class="fas fa-camera"></i> Capturar Tela
                            </button>
                        </div>
                        <div class="form-container">
                            <div class="loading-overlay" id="loading-refrigeracao">
                                <div class="spinner"></div>
                            </div>
                            <iframe 
                                src="https://docs.google.com/forms/d/e/1FAIpQLSekQ4e_rCSuzitRhtpjq48VR2ttobQvvRr--e0qcTH5PU9azQ/viewform?embedded=true" 
                                class="form-iframe"
                                allow="clipboard-read; clipboard-write"
                                allowfullscreen
                                loading="lazy"
                                onload="handleIframeLoad('loading-refrigeracao')"
                                onerror="handleIframeError('page-refrigeracao', 'https://docs.google.com/forms/d/e/1FAIpQLSekQ4e_rCSuzitRhtpjq48VR2ttobQvvRr--e0qcTH5PU9azQ/viewform')"
                            ></iframe>
                        </div>
                    </div>
                    <!-- Rastreabilidade -->
                    <div class="page" id="page-rastreabilidade">
                        <div class="page-header">
                            <h1><i class="fas fa-route"></i> Rastreabilidade</h1>
                            <p>Registros e atividades de rastreabilidade</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQh0a-BMomvvOomRWYGlmoZSPG6ZuwF1jRXFrm8yhzMzizB9vWBgFiFBRyFBRRHQfVVoRppT3E8FBKS/pubhtml?gid=500914835&single=true" target="_blank" class="btn-primary">
                                <i class="fas fa-table"></i> Acessar Planilha
                            </a>
                            <button class="btn-primary" onclick="takePageScreenshot('rastreabilidade')" style="margin-left: 10px;">
                                <i class="fas fa-camera"></i> Capturar Tela
                            </button>
                        </div>
                        <div class="form-container">
                            <div class="loading-overlay" id="loading-rastreabilidade">
                                <div class="spinner"></div>
                            </div>
                            <iframe 
                                src="https://docs.google.com/forms/d/e/1FAIpQLSciTNSHCOzWsFK0GBQv-GKTqgb5WtijzfaG4azAMyIvcU0Vnw/viewform?embedded=true" 
                                class="form-iframe"
                                allow="clipboard-read; clipboard-write"
                                allowfullscreen
                                loading="lazy"
                                onload="handleIframeLoad('loading-rastreabilidade')"
                                onerror="handleIframeError('page-rastreabilidade', 'https://docs.google.com/forms/d/e/1FAIpQLSciTNSHCOzWsFK0GBQv-GKTqgb5WtijzfaG4azAMyIvcU0Vnw/viewform')"
                            ></iframe>
                        </div>
                    </div>
                    <!-- Documenta√ß√£o -->
                    <div class="page" id="page-documentacao">
                        <div class="page-header">
                            <h1>üìí Documenta√ß√£o</h1>
                            <p>Manuais, procedimentos e documenta√ß√µes t√©cnicas</p>
                        </div>
                        <div class="filter-container">
                            <input type="text" id="searchDocumentacao" class="filter-input" placeholder="üîç Buscar documento..." onkeyup="filterDocuments()">
                            <button class="filter-btn" onclick="clearDocumentSearch()">
                                <i class="fas fa-times"></i> Limpar
                            </button>
                        </div>
                        <div class="documents-container" id="documents-list">
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-spinner fa-spin"></i> Carregando documentos...
                            </div>
                        </div>
                    </div>
                    <!-- Sobre o VLT -->
                    <div class="page" id="page-sobre">
                        <div class="page-header">
                            <h1>‚ÑπÔ∏è Sobre o VLT Carioca</h1>
                            <p>Informa√ß√µes t√©cnicas e mapa da rede</p>
                        </div>
                        <div class="operation-clock">
                            <h2>‚è±Ô∏è Tempo de Opera√ß√£o Cont√≠nuo</h2>
                            <div class="clock-display" id="operation-clock">
                                <span id="op-years">0</span>anos
                                <span id="op-months">0</span>meses
                                <span id="op-days">0</span>dias
                                <span id="op-hours">0</span>h
                                <span id="op-minutes">0</span>m
                                <span id="op-seconds">0</span>s
                            </div>
                        </div>
                        <div class="sobre-container">
                            <div class="sobre-info">
                                <div class="info-card">
                                    <h3>Buscar Esta√ß√£o</h3>
                                    <input type="text" id="searchEstacao" class="search-box" placeholder="Digite o nome ou sigla da esta√ß√£o..." onkeyup="searchStation()">
                                    <div id="estacao-result"></div>
                                </div>
                                <div class="info-card">
                                    <h3>Explorar Linhas</h3>
                                    <button class="linha-btn linha-azul" onclick="showLineStations(1)">üîµ Linha 1 (Azul)</button>
                                    <button class="linha-btn linha-verde" onclick="showLineStations(2)">üü¢ Linha 2 (Verde)</button>
                                    <button class="linha-btn linha-amarela" onclick="showLineStations(3)">üü° Linha 3 (Amarela)</button>
                                    <button class="linha-btn linha-laranja" onclick="showLineStations(4)">üü† Linha 4 (Laranja)</button>
                                    <div id="linhas-list" class="estacoes-list" style="display:none;"></div>
                                </div>
                                <div class="info-card">
                                    <h3>Dados T√©cnicos</h3>
                                    <p><strong>Fabricante:</strong> Alstom</p>
                                    <p><strong>Modelo:</strong> Citadis 402</p>
                                    <p><strong>Alimenta√ß√£o:</strong> 750V CC (APS e SRS)</p>
                                    <p><strong>Peso Vazio:</strong> 60.000 Kg (60 Toneladas)</p>
                                    <p><strong>Peso em Opera√ß√£o:</strong> 82.000 Kg</p>
                                    <p><strong>Velocidade M√°xima:</strong> Atinge cerca de 70 km/h</p>
                                    <p><strong>Inaugura√ß√£o:</strong> 05/06/2016</p>
                                    <p><strong>Op. Comercial:</strong> 06/06/2016</p>
                                </div>
                            </div>
                        </div>
                    </div>
                                        <!-- Cat√°logo -->
                    <div class="page" id="page-catalogo">
                        <div class="page-header">
                            <h1>üìö Cat√°logo de Pe√ßas e Componentes</h1>
                            <p>Navegue pela estrutura do VLT Citadis 402 e consulte a base de cadastro de materiais.</p>
                        </div>

                        <div class="catalogo-layout">
    <!-- Container da Base de Cadastro -->
    <div class="catalogo-column" id="catalogo-materiais-column">
        <div class="column-header">
            <i class="fas fa-database"></i> Base de Cadastro de Materiais
        </div>
        <div class="search-container">
            <input type="text" id="materialSearchInput" placeholder="Buscar material (nome, c√≥digo, descri√ß√£o)..." onkeyup="searchMateriais()">
            <button onclick="clearMaterialSearch()"><i class="fas fa-times"></i></button>
        </div>
        <div class="materiais-grid" id="materiaisGrid">
             <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Carregando materiais...</span>
            </div>
        </div>
    </div>
</div>

                        <!-- Modal para Detalhes do Item -->
                        <div id="itemDetailsModal" class="modal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2 id="modalTitle">Detalhes do Item</h2>
                                    <button class="modal-close-btn" onclick="closeModal()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <div class="modal-tabs">
                                        <button class="modal-tab-btn active" onclick="switchModalTab('details')">Detalhes</button>
                                        <button class="modal-tab-btn" onclick="switchModalTab('images')">Imagens</button>
                                    </div>
                                    <div id="modalTabContent" class="modal-tab-content">
                                        <!-- O conte√∫do ser√° injetado aqui pelo JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                <!-- Cole esta p√°gina inteira dentro da <div class="pages-wrapper"> -->
<!-- Programa√ß√£o -->
<div class="page" id="page-programacao">
    <div class="page-header">
        <h1>üìÖ Programa√ß√£o</h1>
        <p>Visualiza√ß√£o da programa√ß√£o de atividades</p>
    </div>
    <div style="margin-bottom: 20px;">
        <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vQh0a-BMomvvOomRWYGlmoZSPG6ZuwF1jRXFrm8yhzMzizB9vWBgFiFBRyFBRRHQfVVoRppT3E8FBKS/pubhtml?gid=1564591852&single=true" target="_blank" class="btn-primary">
            <i class="fas fa-table"></i> Acessar Planilha
        </a>
        <button class="btn-primary" onclick="takePageScreenshot('programacao')" style="margin-left: 10px;">
            <i class="fas fa-camera"></i> Capturar Tela
        </button>
    </div>
    <div class="table-container" style="min-height: 650px;">
        <div class="loading-overlay" id="loading-programacao">
            <div class="spinner"></div>
        </div>
        <iframe 
            src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTI602SZCvv3Vljbau78ZXFxNxUVQATWF1aefTd0rxh6zXpmhV9nDjmpimnDO5vkHLKpWZl82Kw4Gu2/pubhtml?gid=1888450540&single=true" 
            frameborder="0" 
            style="border: 0; width: 100%; height: 650px;" 
            onload="document.getElementById('loading-programacao').classList.add('hidden')"
            allowfullscreen
        ></iframe>
    </div>
    <!-- Plano de Frota -->
<div class="page" id="page-plano_frota">
    <div class="page-header">
        <h1>üöÜ Plano de Frota</h1>
        <p>Visualiza√ß√£o do plano de frota em tempo real, integrado √† planilha oficial.</p>
    </div>

    <div style="margin-bottom: 20px;">
        <a href="https://docs.google.com/spreadsheets/d/e/2PACX-1vTe1CnKo3StuV2ajHM7_MxXdVvcySPxsFPb93QOlwRoxh961iuNiieETY4HpJVSDKTm1o4qNjC5tJSH/pubhtml?gid=1380669578&single=true"
           target="_blank"
           class="btn-primary">
            <i class="fas fa-table"></i> Acessar planilha no Google Sheets
        </a>
    </div>

    <div class="form-container">
        <iframe
            class="form-iframe"
            src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTe1CnKo3StuV2ajHM7_MxXdVvcySPxsFPb93QOlwRoxh961iuNiieETY4HpJVSDKTm1o4qNjC5tJSH/pubhtml?gid=1380669578&single=true"
            frameborder="0"
            loading="lazy">
        </iframe>
    </div>
</div>
                </div>
                <div class="motivational-quote" id="motivational-quote">
                    üí™ Excel√™ncia √© a jornada, n√£o o destino!
                </div>
            </div>
        </main>
    </div>
    <!-- Modal Perfil -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeProfileModal()">‚úï</button>
            <div class="modal-title">üë§ Meu Perfil</div>
            <div class="modal-section">
                <div class="modal-label">Nome Completo</div>
                <div class="modal-value" id="perfil-nome">-</div>
            </div>
            <div class="modal-section">
                <div class="modal-label">Usu√°rio</div>
                <div class="modal-value" id="perfil-usuario">-</div>
            </div>
            <div class="modal-section">
                <div class="modal-label">Email</div>
                <div class="modal-value" id="perfil-email">-</div>
            </div>
            <div class="modal-section">
                <div class="modal-label">Telefone / WhatsApp</div>
                <div class="modal-value" id="perfil-telefone">-</div>
            </div>
            <div class="modal-section">
                <div class="modal-label">Endere√ßo</div>
                <div class="modal-value" id="perfil-endereco">-</div>
            </div>
            <div class="modal-section">
                <div class="modal-label">Matr√≠cula</div>
                <div class="modal-value" id="perfil-matricula">-</div>
            </div>
            <div class="modal-section">
                <div class="modal-label">Tipo de Acesso</div>
                <div class="modal-value" id="perfil-tipo">-</div>
            </div>
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
                <button style="width: 100%; padding: 12px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Sair do Sistema
                </button>
            </div>
        </div>
    </div>
    <!-- Modal Suporte -->
    <div id="supportModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeSupportModal()">‚úï</button>
            <div class="modal-title">üìû Suporte T√©cnico</div>
            <div class="modal-section">
                <div class="modal-label">Contato</div>
                <div class="modal-value">Guilherme Juraci</div>
            </div>
            <div class="modal-section">
                <div class="modal-label">Email</div>
                <div class="modal-value">
                    <a href="mailto:guilherme.fernandes@motiva.com.br" class="modal-link">
                        üìß guilherme.fernandes@motiva.com.br
                    </a>
                </div>
            </div>
            <div class="modal-section">
                <div class="modal-label">WhatsApp</div>
                <div class="modal-value">
                    <a href="https://wa.me/5521970363062" target="_blank" class="modal-link">
                        üí¨ Clique para conversar no WhatsApp
                    </a>
                </div>
            </div>
            <div style="background: #f0f7ff; padding: 15px; border-radius: 5px; border-left: 4px solid var(--primary); margin-top: 20px; font-size: 14px; color: var(--dark); line-height: 1.6;">
                <strong>Precisa de ajuda?</strong><br>
                Estou aqui para suportar voc√™! Entre em contato via email ou WhatsApp. üôå
            </div>
        </div>
    </div>
    <!-- Modal Filtro Passagem de Servi√ßo -->
    <div id="passagemFilterModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closePassagemFilterModal()">‚úï</button>
            <div class="modal-title">üîç Filtrar Passagem de Servi√ßo</div>
            <div class="modal-section">
                <div class="modal-label">Selecione o Grupo</div>
                <select id="passagemGrupoOld" class="filter-select" style="width: 100%;">
                    <option value="GRUPO A">GRUPO A</option>
                    <option value="GRUPO B">GRUPO B</option>
                    <option value="GRUPO C">GRUPO C</option>
                    <option value="GRUPO D">GRUPO D</option>
                </select>
            </div>
            <div class="modal-section">
                <div class="modal-label">Selecione a Data do Plant√£o</div>
                <input type="date" id="passagemDataOld" class="filter-input" style="width: 100%;">
            </div>
            <button class="btn-primary" style="width: 100%; margin-top: 20px;" onclick="applyPassagemFilterOld()">
                <i class="fas fa-search"></i> Buscar Dados do Plant√£o
            </button>
        </div>
    </div>
    <script>
        
    // VARI√ÅVEIS GLOBAIS
    let currentUser = null;
    let allRegistros = [];
    let filteredPassagemData = [];

    // URL DA PLANILHA CSV
    const REGISTRO_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTI602SZCvv3Vljbau78ZXFxNxUVQATWF1aefTd0rxh6zXpmhV9nDjmpimnDO5vkHLKpWZl82Kw4Gu2/pub?gid=195449004&single=true&output=csv';

   // FUN√á√ÉO DE AUTENTICA√á√ÉO (CORRIGIDA)
function checkAuth() {
    // 1. Pega os dados do usu√°rio salvos no sessionStorage pelo login
    const userData = sessionStorage.getItem('vlt_user');
    
    // 2. Verifica se os dados existem. Se n√£o, redireciona para o login.
    if (!userData) {
        window.location.href = 'index.html';
        return null; // Retorna null para indicar que n√£o h√° usu√°rio
    }
    
    // 3. Converte os dados de string para objeto
    const user = JSON.parse(userData);
    
    // 4. Retorna o objeto do usu√°rio para ser usado no dashboard
    return user;
}

    // INICIALIZA√á√ÉO (mantida)
    document.addEventListener('DOMContentLoaded', function() {
        console.log("üöÄ Inicializando Dashboard VLT Carioca...");
        currentUser = checkAuth();
        if (currentUser) {
            console.log("‚úÖ Usu√°rio autenticado:", currentUser.usuario);
            const usuario = currentUser.usuario;
            document.getElementById('userName').textContent = usuario;
            document.getElementById('userRole').textContent = currentUser.tipo;
            const initials = usuario.split('.').map(n => n[0].toUpperCase()).join('');
            document.getElementById('userInitials').textContent = initials;
            if (currentUser.tipo !== 'ADMIN') {
                document.getElementById('usuarios-menu').style.display = 'none';
                document.getElementById('relatorios-menu').style.display = 'none';
            }
            loadUserProfile(usuario);
        }
        updateOperationClock();
        setInterval(updateOperationClock, 1000);
        updateMotivationalQuote();
        setInterval(updateMotivationalQuote, 30000);
        console.log("‚úÖ Dashboard inicializado com sucesso!");
    });

    // FUN√á√ÉO PARA CARREGAR PERFIL DO USU√ÅRIO (mantida)
    // FUN√á√ÉO PARA CARREGAR PERFIL DO USU√ÅRIO (VERS√ÉO CORRIGIDA)
// FUN√á√ÉO PARA CARREGAR PERFIL DO USU√ÅRIO (VERS√ÉO FINAL E CORRIGIDA)
function loadUserProfile(usuario) {
    // A vari√°vel 'usuario' vem do checkAuth() e cont√©m o usu√°rio logado.
    console.log("Tentando carregar perfil para o usu√°rio:", usuario);

    // URL da planilha de usu√°rios (certifique-se de que esta √© a URL de "Publicar na web")
    const USUARIOS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTI602SZCvv3Vljbau78ZXFxNxUVQATWF1aefTd0rxh6zXpmhV9nDjmpimnDO5vkHLKpWZl82Kw4Gu2/pub?gid=1605075317&single=true&output=csv';

    // Atualiza o nome de usu√°rio e tipo na barra superior imediatamente
    document.getElementById('userName').textContent = usuario;
    document.getElementById('userRole').textContent = currentUser.tipo;
    const initials = usuario.split('.').map(n => n[0].toUpperCase()).join('');
    document.getElementById('userInitials').textContent = initials;

    // Busca os dados detalhados na planilha
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000); // Timeout de 8 segundos

    fetch(USUARIOS_CSV, { signal: controller.signal })
        .then(r => {
            if (!r.ok) throw new Error('Network response was not ok');
            return r.text();
        })
        .then(csv => {
            clearTimeout(timeoutId);
            const rows = parseCSV(csv);
            // Procura pelo usu√°rio na coluna 'Usu√°rio' da planilha
            const userRow = rows.find(r => r.Usu√°rio === usuario || r.Usuario === usuario);
            
            if (userRow) {
                console.log("Dados do usu√°rio encontrados na planilha:", userRow);
                
                // Extrai os dados da planilha usando os nomes de coluna corretos
                const nomeCompleto = userRow.Nome_Completo || '-';
                const email = userRow.Email || '-';
                const telefone = userRow.Telefone || '';
                const endereco = userRow.Endereco || '-';
                const matricula = userRow.Matr√≠cula || '-';
                const tipo = userRow.Tipo || currentUser.tipo || '-';

                // Cria o link do WhatsApp se o telefone existir
                const whatsappLink = telefone ? `<a href="https://wa.me/55${telefone.replace(/\D/g, '')}" target="_blank" class="modal-link"><i class="fab fa-whatsapp"></i> Clique para conversar</a>` : 'N√£o informado';
                
                // Preenche o modal "Meu Perfil" com os dados da planilha
                document.getElementById('perfil-nome').textContent = nomeCompleto;
                document.getElementById('perfil-usuario').textContent = usuario;
                document.getElementById('perfil-email').textContent = email;
                document.getElementById('perfil-telefone').innerHTML = whatsappLink;
                document.getElementById('perfil-endereco').textContent = endereco;
                document.getElementById('perfil-matricula').textContent = matricula;
                document.getElementById('perfil-tipo').textContent = tipo;
            } else {
                console.warn("Usu√°rio n√£o encontrado na planilha. Usando dados do login.");
                // Se n√£o encontrar na planilha, usa os dados do login e preenche o resto com '-'
                document.getElementById('perfil-nome').textContent = currentUser.nome || usuario;
                document.getElementById('perfil-usuario').textContent = usuario;
                document.getElementById('perfil-email').textContent = 'N√£o informado';
                document.getElementById('perfil-telefone').textContent = 'N√£o informado';
                document.getElementById('perfil-endereco').textContent = 'N√£o informado';
                document.getElementById('perfil-matricula').textContent = 'N√£o informado';
                document.getElementById('perfil-tipo').textContent = currentUser.tipo || 'USU√ÅRIO';
            }
        })
        .catch(e => {
            clearTimeout(timeoutId);
            console.error('Erro ao carregar perfil da planilha (usando defaults):', e);
            // Em caso de erro de rede, preenche com os dados do login
            document.getElementById('perfil-nome').textContent = currentUser.nome || usuario;
            document.getElementById('perfil-usuario').textContent = usuario;
            document.getElementById('perfil-email').textContent = 'N√£o informado';
            document.getElementById('perfil-telefone').textContent = 'N√£o informado';
            document.getElementById('perfil-endereco').textContent = 'N√£o informado';
            document.getElementById('perfil-matricula').textContent = 'N√£o informado';
            document.getElementById('perfil-tipo').textContent = currentUser.tipo || 'USU√ÅRIO';
        });
}

    // FUN√á√ÉO PRINCIPAL PARA MOSTRAR P√ÅGINAS (mantida)
    function showPage(pageName, event = null) {
        console.log("üîÑ Navegando para p√°gina:", pageName);
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const targetPage = document.getElementById('page-' + pageName);
        if (targetPage) {
            targetPage.classList.add('active');
            console.log("‚úÖ P√°gina exibida com sucesso");
        } else {
            console.error("‚ùå P√°gina n√£o encontrada:", pageName);
        }
        
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        }
        const titles = {
    'dashboard': 'üìä Dashboard',
    'plantao': 'üïí Plant√£o',
    'passagem': 'üìã Passagem de Servi√ßo',
    'novo_registro': '‚ûï Novo Registro',
    'usuarios': 'üë• Usu√°rios',
    'laboratorio': 'üß™ Laborat√≥rio',
    'eva': 'ü§ñ EVA',
    'refrigeracao': '‚ùÑÔ∏è Refrigera√ß√£o',
    'rastreabilidade': 'üõ∞Ô∏è Rastreabilidade',
    'documentacao': 'üìö Documenta√ß√£o',
    'catalogo': 'üìñ Cat√°logo',
    'programacao': 'üìÖ Programa√ß√£o',
    'plano_frota': 'üöÜ Plano de Frota',
    'sobre': '‚ÑπÔ∏è Sobre o VLT'
};

        document.getElementById('breadcrumb').textContent = titles[pageName] || pageName;
        updateMotivationalQuote();
        const screenshotBtn = document.getElementById('screenshotBtn');
        if (['documentacao', 'sobre', 'catalogo'].includes(pageName)) { 
        } else {
            screenshotBtn.style.display = 'none'; 
        }
        if (pageName === 'passagem') {
            document.getElementById('passagem-filters').style.display = 'flex';
            loadPassagemData(); // Carrega os dados quando a p√°gina √© aberta
        } else {
            document.getElementById('passagem-filters').style.display = 'none';
        }
        if (pageName === 'usuarios') loadUsuarios();
        if (pageName === 'documentacao') loadDocumentacao();
        if (pageName === 'relatorios') {
            document.getElementById('relatorio-table').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;">Clique em "Aplicar Filtros" para gerar o relat√≥rio</td></tr>';
        }

        if (pageName === 'catalogo') showCatalogoPage();
    }

    // FUN√á√ïES PARA PASSAGEM DE SERVI√áO (CORRIGIDAS E LIMPA)

    // Fun√ß√£o para capturar tela
    function takePassagemScreenshot() {
        const element = document.getElementById('page-passagem');
        html2canvas(element, { 
            allowTaint: true, 
            useCORS: true,
            scale: 2,
            backgroundColor: '#ffffff'
        }).then(canvas => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'VLT_Passagem_Servico_' + new Date().toLocaleString('pt-BR').replace(/[/\\:]/g, '-') + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }

    // Fun√ß√£o para abrir o modal antigo de filtro
    function openPassagemFilterModal() { 
        document.getElementById('passagemFilterModal').classList.add('show'); 
    }

    // Fun√ß√£o para fechar o modal antigo de filtro
    function closePassagemFilterModal() { 
        document.getElementById('passagemFilterModal').classList.remove('show'); 
    }

    // Fun√ß√£o para aplicar filtro do modal antigo
    function applyPassagemFilterOld() {
        const grupo = document.getElementById('passagemGrupoOld').value;
        const dataStr = document.getElementById('passagemDataOld').value;
        if (!dataStr) { 
            alert('Por favor, selecione uma data.'); 
            return; 
        }
        document.getElementById('passagemGrupo').value = grupo;
        document.getElementById('passagemData').value = dataStr;
        applyPassagemFilters();
        closePassagemFilterModal();
    }

    // Fun√ß√£o principal para aplicar filtros
    function applyPassagemFilters() {
        // Verifica se os dados j√° foram carregados
        if (allRegistros.length === 0) {
            // Se n√£o, carrega-os primeiro
            fetch(REGISTRO_CSV).then(r => r.text()).then(csv => { 
                allRegistros = parseCSV(csv); 
                processPassagemFilters(); // Depois de carregar, aplica os filtros
            }).catch(error => {
                console.error('Erro ao carregar planilha:', error);
                // Mostra erro na tabela
                document.getElementById('passagem-table').innerHTML = `
                    <tr><td colspan="7" style="text-align:center;padding:40px;color:red;">
                        ‚ùå Erro ao carregar dados: ${error.message}
                    </td></tr>
                `;
            });
        } else {
            // Se j√° carregados, aplica os filtros imediatamente
            processPassagemFilters();
        }
    }

    // Fun√ß√£o para processar os filtros e atualizar a tabela
    function processPassagemFilters() {
        const dataSelecionada = document.getElementById('passagemData').value;
        const grupo = document.getElementById('passagemGrupo').value;
        const trem = document.getElementById('passagemTrem').value.toLowerCase();
        const sistema = document.getElementById('passagemSistema').value.toLowerCase();
        const tecnico = document.getElementById('passagemTecnico').value.toLowerCase();
        const status = document.getElementById('passagemStatus').value;

        // Filtra os registros
        filteredPassagemData = allRegistros.filter(r => {
            try {
                const dataRegistro = r['Carimbo de data/hora'] || '';
                // Filtrar por data (se fornecida)
                if (dataSelecionada) {
                    const partsFiltro = dataSelecionada.split('-');
                    const dataFiltroFormatada = `${partsFiltro[2]}/${partsFiltro[1]}/${partsFiltro[0]}`;
                    const dataRegistroFormatada = dataRegistro.split(' ')[0];
                    if (dataRegistroFormatada !== dataFiltroFormatada) {
                        return false;
                    }
                }
                // Filtrar por grupo
                if (grupo && r['GRUPO'] !== grupo) return false;
                // Filtrar por trem
                if (trem && !r['N√öMERO DO TREM'].toLowerCase().includes(trem)) return false;
                // Filtrar por sistema
                if (sistema && !r['SISTEMAS'].toLowerCase().includes(sistema)) return false;
                // Filtrar por t√©cnico
                if (tecnico && !r['NOME E SOBRENOME'].toLowerCase().includes(tecnico)) return false;
                // Filtrar por status
                if (status) { 
                    const statusRegistro = (r['STATUS ATUAL DO TREM'] || '').toUpperCase();
                    if (!statusRegistro.includes(status.toUpperCase())) return false; 
                }
                return true;
            } catch (e) { 
                console.log('‚ùå Erro no filtro:', e, r); 
                return false; 
            }
        });

        // Renderiza a tabela com os resultados filtrados
        renderPassagemTable();
    }

    // Fun√ß√£o para renderizar a tabela
    function renderPassagemTable() {
        const table = document.getElementById('passagem-table');
        if (filteredPassagemData.length === 0) {
            table.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">Nenhum registro encontrado para os filtros aplicados.</td></tr>';
        } else {
            table.innerHTML = filteredPassagemData.map(r => {
                const data = r['Carimbo de data/hora'] || '';
                const nome = r['NOME E SOBRENOME'] || '';
                const trem = r['N√öMERO DO TREM'] || '';
                const sistema = r['SISTEMAS'] || '';
                const descricao = r['DESCRI√á√ÉO DETALHADA'] || '';
                const status = r['STATUS ATUAL DO TREM'] || 'N√ÉO INFORMADO';
                return `
                    <tr>
                        <td>${data}</td>
                        <td>${nome}</td>
                        <td>${trem}</td>
                        <td>${sistema}</td>
                        <td>${descricao}</td>
                        <td>${status}</td>
                    </tr>
                `;
            }).join('');
        }
    }

    // Fun√ß√£o para limpar os filtros
    function clearPassagemFilters() {
        ['passagemData', 'passagemGrupo', 'passagemTrem', 'passagemSistema', 'passagemTecnico', 'passagemStatus'].forEach(id => document.getElementById(id).value = '');
        filteredPassagemData = [];
        document.getElementById('passagem-table').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">Clique em "Aplicar Filtros" para gerar os dados</td></tr>';
    }

    // Fun√ß√£o para carregar os dados da planilha (chamada quando a p√°gina √© aberta)
    function loadPassagemData() { 
        if (allRegistros.length === 0) { 
            // Mostra "Carregando..." na tabela
            document.getElementById('passagem-table').innerHTML = `
                <tr><td colspan="7" style="text-align:center;padding:40px;" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Carregando dados da planilha...
                </td></tr>
            `;
            fetch(REGISTRO_CSV).then(r => r.text()).then(csv => { 
                allRegistros = parseCSV(csv); 
                // Ap√≥s carregar, mostra a mensagem inicial
                document.getElementById('passagem-table').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">Clique em "Aplicar Filtros" para gerar os dados</td></tr>';
            }).catch(error => {
                console.error('Erro ao carregar dados:', error);
                document.getElementById('passagem-table').innerHTML = `
                    <tr><td colspan="7" style="text-align:center;padding:40px;color:red;">
                        ‚ùå Erro ao carregar dados: ${error.message}
                    </td></tr>
                `;
            });
        } 
    }

    // FUN√á√ÉO DE PARSING CSV (mantida)
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length === 0) return [];
        const headers = parseCSVLine(lines[0]);
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim() === '') continue;
            const values = parseCSVLine(lines[i]);
            const obj = {};
            headers.forEach((header, idx) => {
                const cleanHeader = header.trim().replace(/"/g, '');
                obj[cleanHeader] = values[idx] ? values[idx].trim().replace(/"/g, '') : '';
            });
            rows.push(obj);
        }
        return rows;
    }
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current);
        return result;
    }

    // FUN√á√ïES GERAIS (mantidas)
    function takeScreenshot() {
        const element = document.querySelector('.page.active');
        html2canvas(element, { 
            allowTaint: true, 
            useCORS: true,
            scale: 2,
            backgroundColor: '#ffffff'
        }).then(canvas => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'VLT_Screenshot_' + new Date().toLocaleString('pt-BR').replace(/[/\\:]/g, '-') + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }
    function takePageScreenshot(pageName) {
        const element = document.getElementById('page-' + pageName);
        html2canvas(element, { 
            allowTaint: true, 
            useCORS: true,
            scale: 2,
            backgroundColor: '#ffffff'
        }).then(canvas => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'VLT_' + pageName + '_' + new Date().toLocaleString('pt-BR').replace(/[/\\:]/g, '-') + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    }
    function loadUsuarios() {
        fetch(USUARIOS_CSV).then(r => r.text()).then(csv => {
            const rows = parseCSV(csv);
            const table = document.getElementById('usuarios-table');
            table.innerHTML = rows.map(r => `
                <tr>
                    <td>${r.Usuario || ''}</td>
                    <td>${r.Nome_Completo || ''}</td>
                    <td>${r.Email || ''}</td>
                    <td>${r.Telefone || ''}</td>
                    <td>${r.Tipo || ''}</td>
                    <td>${r.Status || 'Ativo'}</td>
                </tr>
            `).join('');
        }).catch(e => {
            console.error('Erro ao carregar usu√°rios:', e);
            document.getElementById('usuarios-table').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;">Erro ao carregar usu√°rios.</td></tr>';
        });
    }
    function openProfileModal() {
        document.getElementById('profileModal').classList.add('show');
        loadUserProfile(currentUser.usuario);
    }
    function closeProfileModal() {
        document.getElementById('profileModal').classList.remove('show');
    }
    function logout() {
        sessionStorage.removeItem('vlt_user');
        window.location.href = 'index.html';
    }
    function updateMotivationalQuote() {
        const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
        document.getElementById('motivational-quote').textContent = quote;
    }
    function updateOperationClock() {
        const startDate = new Date('2016-06-06T00:00:00');
        const now = new Date();
        const diff = now - startDate;
        const years = Math.floor(diff / (1000 * 60 * 60 * 24 * 365));
        const months = Math.floor((diff % (1000 * 60 * 60 * 24 * 365)) / (1000 * 60 * 60 * 24 * 30));
        const days = Math.floor((diff % (1000 * 60 * 60 * 24 * 30)) / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        document.getElementById('op-years').textContent = years;
        document.getElementById('op-months').textContent = months;
        document.getElementById('op-days').textContent = days;
        document.getElementById('op-hours').textContent = hours;
        document.getElementById('op-minutes').textContent = minutes;
        document.getElementById('op-seconds').textContent = seconds;
    }
    function searchStation() {
        const searchTerm = document.getElementById('searchEstacao').value.toLowerCase();
        const resultDiv = document.getElementById('estacao-result');
        if (searchTerm.length < 2) {
            resultDiv.innerHTML = '';
            return;
        }
        let results = [];
        for (let lineNum in linhasData) {
            const line = linhasData[lineNum];
            for (let sigla in line.estacoes) {
                const nome = line.estacoes[sigla];
                if (sigla.toLowerCase().includes(searchTerm) || nome.toLowerCase().includes(searchTerm)) {
                    results.push({ sigla, nome, linha: lineNum, cor: line.cor });
                }
            }
        }
        if (results.length > 0) {
            resultDiv.innerHTML = results.map(r => `
                <div class="estacao-item highlight">
                    <strong>${r.sigla}</strong> - ${r.nome} (Linha ${r.linha} - ${r.cor})
                </div>
            `).join('');
        } else {
            resultDiv.innerHTML = '<div class="estacao-item">Nenhuma esta√ß√£o encontrada</div>';
        }
    }
    function showLineStations(lineNum) {
        const listDiv = document.getElementById('linhas-list');
        const line = linhasData[lineNum];
        if (listDiv.style.display === 'none' || listDiv.dataset.currentLine !== lineNum) {
            listDiv.innerHTML = Object.entries(line.estacoes).map(([sigla, nome]) => `
                <div class="estacao-item">
                    <strong>${sigla}</strong> - ${nome}
                </div>
            `).join('');
            listDiv.style.display = 'block';
            listDiv.dataset.currentLine = lineNum;
        } else {
            listDiv.style.display = 'none';
        }
    }
    function applyFilters() {
        const dataInicio = document.getElementById('filterDataInicio').value;
        const dataFim = document.getElementById('filterDataFim').value;
        const trem = document.getElementById('filterTrem').value.toLowerCase();
        const sistema = document.getElementById('filterSistema').value.toLowerCase();
        const equipe = document.getElementById('filterEquipe').value.toLowerCase();
        const tecnico = document.getElementById('filterTecnico').value.toLowerCase();
        const ios = document.getElementById('filterIOS').value.toLowerCase();
        const status = document.getElementById('filterStatus').value;
        if (allRegistros.length === 0) {
            fetch(REGISTRO_CSV).then(r => r.text()).then(csv => {
                allRegistros = parseCSV(csv);
                processReportFilters();
            }).catch(console.error);
        } else {
            processReportFilters();
        }
    }
    function processReportFilters() {
        filteredReportData = allRegistros.filter(r => {
            const dataRegistro = r['Carimbo de data/hora'] || '';
            if (dataInicio && dataRegistro < dataInicio) return false;
            if (dataFim && dataRegistro > dataFim) return false;
            if (trem && !r['N√öMERO DO TREM'].toLowerCase().includes(trem)) return false;
            if (sistema && !r['SISTEMAS'].toLowerCase().includes(sistema)) return false;
            if (equipe && !r['GRUPO'].toLowerCase().includes(equipe)) return false;
            if (tecnico && !r['NOME E SOBRENOME'].toLowerCase().includes(tecnico)) return false;
            if (ios && !r['IOS'].toLowerCase().includes(ios)) return false;
            if (status && !r['STATUS ATUAL DO TREM'].toLowerCase().includes(status.toLowerCase())) return false;
            return true;
        });
        renderReportTable();
        document.getElementById('download-buttons').style.display = 'flex';
    }
    function renderReportTable() {
        const table = document.getElementById('relatorio-table');
        if (filteredReportData.length === 0) {
            table.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;">Nenhum registro encontrado para os filtros aplicados.</td></tr>';
        } else {
            table.innerHTML = filteredReportData.map(r => {
                return `
                    <tr>
                        <td>${r['Carimbo de data/hora'] || ''}</td>
                        <td>${r['NOME E SOBRENOME'] || ''}</td>
                        <td>${r['N√öMERO DO TREM'] || ''}</td>
                        <td>${r['SISTEMAS'] || ''}</td>
                        <td>${r['IOS'] || ''}</td>
                        <td>${r['DESCRI√á√ÉO DETALHADA'] || ''}</td>
                        <td>${r['STATUS ATUAL DO TREM'] || ''}</td>
                    </tr>
                `;
            }).join('');
        }
    }
    function clearFilters() {
        ['filterDataInicio', 'filterDataFim', 'filterTrem', 'filterSistema', 'filterEquipe', 'filterTecnico', 'filterIOS', 'filterStatus'].forEach(id => document.getElementById(id).value = '');
        filteredReportData = [];
        document.getElementById('relatorio-table').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:40px;">Clique em "Aplicar Filtros" para gerar o relat√≥rio</td></tr>';
        document.getElementById('download-buttons').style.display = 'none';
    }
    function downloadCSV() {
        if (filteredReportData.length === 0) {
            alert('Nenhum dado para exportar');
            return;
        }
        const headers = ['Data', 'T√©cnico', 'Trem', 'Sistema', 'IOS', 'Descri√ß√£o', 'Status'];
        const rows = filteredReportData.map(r => [
            r['Carimbo de data/hora'] || '',
            r['NOME E SOBRENOME'] || '',
            r['N√öMERO DO TREM'] || '',
            r['SISTEMAS'] || '',
            r['IOS'] || '',
            r['DESCRI√á√ÉO DETALHADA'] || '',
            r['STATUS ATUAL DO TREM'] || ''
        ]);
        let csvContent = headers.join(',') + '\n';
        rows.forEach(row => {
            csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'VLT_Relatorio_' + new Date().toLocaleString('pt-BR').replace(/[/\\:]/g, '-') + '.csv';
        link.click();
    }
    function downloadPDF() {
        if (filteredReportData.length === 0) {
            alert('Nenhum dado para exportar');
            return;
        }
        const element = document.getElementById('page-relatorios');
        html2pdf()
            .from(element)
            .set({
                margin: 10,
                filename: 'VLT_Relatorio_' + new Date().toLocaleString('pt-BR').replace(/[/\\:]/g, '-') + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            })
            .save();
    }
    function toggleSidebar() { 
        document.querySelector('.sidebar').classList.toggle('collapsed'); 
    }
    function handleIframeLoad(loadingId) {
        console.log("‚úÖ Iframe carregado com sucesso:", loadingId);
        document.getElementById(loadingId).classList.add('hidden');
    }
    function handleIframeError(pageId, formUrl) {
        console.error("‚ùå Erro ao carregar iframe para:", pageId);
        const loadingOverlay = document.getElementById('loading-' + pageId.split('-')[1]);
        if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
        }
        const iframeContainer = document.getElementById(pageId).querySelector('.form-container');
        if (iframeContainer) {
            const iframe = iframeContainer.querySelector('iframe');
            if (iframe) {
                iframe.style.display = 'none';
            }
            iframeContainer.innerHTML = `
                <div class="fallback-container">
                    <div class="fallback-message">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 20px;"></i>
                        <h3 style="color: var(--dark); margin-bottom: 10px;">Formul√°rio n√£o dispon√≠vel no iframe</h3>
                        <p style="color: #666; line-height: 1.5; max-width: 600px;">
                            Por motivos de seguran√ßa, o Google bloqueou a incorpora√ß√£o deste formul√°rio. 
                            Clique no bot√£o abaixo para abrir o formul√°rio em uma nova aba.
                        </p>
                    </div>
                    <button class="fallback-btn" onclick="window.open('${formUrl}', '_blank')">
                        <i class="fas fa-external-link-alt"></i> Abrir Formul√°rio em Nova Aba
                    </button>
                </div>
            `;
        }
    }
    function openSupportModal() {
        document.getElementById('supportModal').classList.add('show');
    }
    function closeSupportModal() {
        document.getElementById('supportModal').classList.remove('show');
    }
    function loadDocumentacao() {
        const container = document.getElementById('documents-list');
        if (!documentosPDF || documentosPDF.length === 0) {
            container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-folder-open" style="font-size: 48px; margin-bottom: 20px;"></i>
                <p>Nenhum documento encontrado.</p>
            </div>`;
            return;
        }
        container.innerHTML = documentosPDF.map(doc => `
            <div class="document-card" data-category="${doc.categoria}" data-name="${doc.nome.toLowerCase()}">
                <div class="document-icon">
                    <i class="fas fa-file-pdf"></i>
                </div>
                <div class="document-title">${doc.nome}</div>
                <div class="document-info">
                    <div><i class="fas fa-tag"></i> ${doc.categoria}</div>
                    <div><i class="fas fa-file"></i> ${doc.tamanho || 'Tamanho n√£o informado'}</div>
                    <div><i class="fas fa-info-circle"></i> ${doc.descricao}</div>
                </div>
                <div class="document-actions">
                    <button class="document-btn view" onclick="viewDocument('${doc.arquivo}')">
                        <i class="fas fa-eye"></i> Visualizar
                    </button>
                    <button class="document-btn download" onclick="downloadDocument('${doc.arquivo}', '${doc.nome}')">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        `).join('');
    }
    function viewDocument(filePath) { 
        window.open(filePath, '_blank'); 
    }
    function downloadDocument(filePath, fileName) {
        const link = document.createElement('a');
        link.href = filePath;
        link.download = fileName + '.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    function filterDocuments() {
        const searchTerm = document.getElementById('searchDocumentacao').value.toLowerCase();
        const cards = document.querySelectorAll('.document-card');
        cards.forEach(card => {
            const docName = card.getAttribute('data-name');
            const docCategory = card.getAttribute('data-category').toLowerCase();
            card.style.display = (docName.includes(searchTerm) || docCategory.includes(searchTerm)) ? 'block' : 'none';
        });
    }
    function clearDocumentSearch() {
        document.getElementById('searchDocumentacao').value = '';
        document.querySelectorAll('.document-card').forEach(card => card.style.display = 'block');
    }

    // FRASES MOTIVACIONAIS (mantida)
    const motivationalQuotes = [ 
        "üí™ Excel√™ncia √© a jornada, n√£o o destino!", 
        "üöÜ Seguran√ßa em primeiro lugar, sempre!", 
        "üõ°Ô∏è Prote√ß√£o √© responsabilidade de todos!", 
        "‚ö° Somos o cora√ß√£o ferrovi√°rio do Rio!", 
        "üéØ Precis√£o e dedica√ß√£o em cada opera√ß√£o!", 
        "üë• Juntos fazemos a diferen√ßa!", 
        "üåü VLT Carioca: Mobilidade com seguran√ßa!", 
        "‚úÖ Qualidade: nosso compromisso!", 
        "üöÄ Inova√ß√£o todos os dias!", 
        "‚ù§Ô∏è Paix√£o pelo que fazemos!", 
        "üèÜ Somos os melhores ferrovi√°rios!", 
        "üîß Manuten√ß√£o impec√°vel, sempre!", 
        "‚≠ê Fa√ßa sua parte, sempre com cuidado!", 
        "üíØ 100% de comprometimento!", 
        "üéñÔ∏è Orgulho de servir a popula√ß√£o!", 
        "üöá Conectando vidas, cidades e sonhos!", 
        "üõ°Ô∏è Cada detalhe conta para a seguran√ßa!", 
        "üë®‚Äçüîß Profissionalismo em tudo!", 
        "üåâ VLT: Lideran√ßa em mobilidade urbana!", 
        "üí° Ideias para melhorar a cada dia!",
        "ü¶∫MRO = SEGURAN√áA"
    ];

    // DADOS DAS LINHAS (mantida)
    const linhasData = {
        1: { cor: 'Azul', estacoes: { 'SDU': 'Santos Dumont', 'ACM': 'Ant√¥nio Carlos (MAM)', 'CIN': 'Cinel√¢ndia', 'CAR': 'Carioca', 'STS': 'Sete de Setembro', 'CAN': 'Candel√°ria', 'SAB': 'S√£o Bento', 'PAM': 'Parada dos Museus', 'PNV': 'Parada dos Navios (Valongo)', 'UAR': 'Utopia (AquaRio)', 'CDS': 'Cidade do Samba (Tia Ciata)', 'SCR': 'Santo Cristo', 'GAM': 'Gamboa', 'PER': 'Provid√™ncia', 'PRO': 'Provid√™ncia', 'EQU': 'Equador', 'ROD': 'Rodovi√°ria', 'TIG': 'Terminal Gentileza' } },
        2: { cor: 'Verde', estacoes: { 'PXV': 'Pra√ßa XV', 'COL': 'Colombo', 'TIR': 'Tiradentes', 'SAA': 'Saara', 'COA': 'Cristiano Ottoni (Pequena √Åfrica)', 'CEN': 'Central', 'GAM': 'Gamboa', 'SCR': 'Santo Cristo', 'CDG': 'Cordeiro da Gra√ßa', 'VLO': 'Vila Ol√≠mpica', 'PER': 'Pereira Reis', 'EQU': 'Equador', 'ROD': 'Rodovi√°ria', 'PFM': 'Praia Formosa' } },
        3: { cor: 'Amarela', estacoes: { 'SDU': 'Santos Dumont', 'ACM': 'Ant√¥nio Carlos (MAM)', 'CIN': 'Cinel√¢ndia', 'CAR': 'Carioca', 'STS': 'Sete de Setembro', 'CAN': 'Candel√°ria', 'SRN': 'Santa Rita (Pretos Novos)', 'CRN': 'Camerino (Rosas Negras)', 'COA': 'Cristiano Ottoni (Pequena √Åfrica)', 'CEN': 'Central' } },
        4: { cor: 'Laranja', estacoes: { 'PXV': 'Pra√ßa XV', 'COL': 'Colombo', 'TIR': 'Tiradentes', 'SAA': 'Saara', 'COA': 'Cristiano Ottoni (Pequena √Åfrica)', 'CEN': 'Central', 'VLO': 'Vila Ol√≠mpica', 'PER': 'Pereira Reis', 'GAM': 'Gamboa', 'SCR': 'Santo Cristo', 'CDG': 'Cordeiro da Gra√ßa', 'EQU': 'Equador', 'ROD': 'Rodovi√°ria', 'TIG': 'Terminal Gentileza' } }
    };

    // LISTA DE DOCUMENTOS (mantida)
    const documentosPDF = [
        { nome: "ECOPACK FALHAS", descricao: "LISTA DE FALHAS DO ECOPACK", arquivo: "PDF/1525MI falhas.pdf", tamanho: "2.4 MB", categoria: "MANUTEN√á√ÉO" },
        { nome: "Lista IOS", descricao: "LISTA COM IOS E FALHAS", arquivo: "PDF/Lista IOS.pdf", tamanho: "2.1 MB", categoria: "MANUTEN√á√ÉO" },
    ];

    // URLs DOS DADOS (mantida)
    const USUARIOS_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTI602SZCvv3Vljbau78ZXFxNxUVQATWF1aefTd0rxh6zXpmhV9nDjmpimnDO5vkHLKpWZl82Kw4Gu2/pub?gid=1605075317&single=true&output=csv';
    const LABORATORIO_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQh0a-BMomvvOomRWYGlmoZSPG6ZuwF1jRXFrm8yhzMzizB9vWBgFiFBRyFBRRHQfVVoRppT3E8FBKS/pub?gid=43329994&single=true&output=csv';
    const EVA_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQh0a-BMomvvOomRWYGlmoZSPG6ZuwF1jRXFrm8yhzMzizB9vWBgFiFBRyFBRRHQfVVoRppT3E8FBKS/pub?gid=927195938&single=true&output=csv';
    const REFRIGERACAO_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQh0a-BMomvvOomRWYGlmoZSPG6ZuwF1jRXFrm8yhzMzizB9vWBgFiFBRyFBRRHQfVVoRppT3E8FBKS/pub?gid=131107120&single=true&output=csv';
    const RASTREABILIDADE_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQh0a-BMomvvOomRWYGlmoZSPG6ZuwF1jRXFrm8yhzMzizB9vWBgFiFBRyFBRRHQfVVoRppT3E8FBKS/pub?gid=500914835&single=true&output=csv';

    // M√≥dulo Plant√£o (mantido)
    function calcularEscala2x2(data) {
        const dataBase = new Date(2025, 10, 24); // 24/11/2025
        const diffDias = Math.floor((data - dataBase) / (24 * 60 * 60 * 1000));
        const posicaoNoCiclo = ((diffDias % 4) + 4) % 4;
        if (posicaoNoCiclo === 0 || posicaoNoCiclo === 1) {
            return { verde: true, manha: 'B', noite: 'C' };
        } else {
            return { verde: false, manha: 'A', noite: 'D' };
        }
    }
    function getMembros(grupo, turno) {
        const grupos = {
            'A': { diurno: ["DARLAN", "JEFERSON NARCISO"] },
            'B': { diurno: ["DANILO QUINTINO", "LUCAS"] },
            'C': { noturno: ["ANDR√â LUIZ", "GELSON DOMINGUES"] },
            'D': { noturno: ["RAFAEL CAMILO", "ROG√âRIO REIS"] },
            '5x2': {
                diurno: ["GUILHERME JURACI", "EDUARDO POGIANELI", "MAGNO SANTOS", "CLARA LOPES", "MAURO HENRIQUE", "JO√ÉO PEDRO", "ROG√âRIO RAMOS"],
                noturno: ["THIAGO SILVA", "RODOLFO", "VINICIUS SALLES"]
            },
            'EVA': { diurno: ["SERGIO AZEVEDO", "TAIN√Å SANTOS", "IGOR"] },
            'LAB': { diurno: ["ANA CAROLINA", "ANDERSON FRAN√áA", "PAULO", "ANA VIT√ìRIA"] },
            'PREV': { noturno: ["GUILHERME COELHO", "LEONARDO PRADO"] },
            'SUP': { diurno: ["RUAN DE PAULA"] }
        };
        if (grupo === 'LAB' || grupo === 'PREV' || grupo === 'SUP') {
            return grupos[grupo]?.['diurno'] || grupos[grupo]?.['noturno'] || [];
        }
        return grupos[grupo]?.[turno] || [];
    }
    function formatarMembros(array) {
        return array.length ? array.join(', ') : '‚Äî';
    }
    function gerarDiaPlantao(dia, mes, ano) {
        const data = new Date(ano, mes, dia);
        const diaSemana = data.getDay();
        const { verde, manha, noite } = calcularEscala2x2(data);
        let conteudo = `<div style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">${dia}</div>`;
        const membrosManha = formatarMembros(getMembros(manha, 'diurno'));
        const membrosNoite = formatarMembros(getMembros(noite, 'noturno'));
        const corFundo = verde ? '#E8F5E9' : '#FFFEF2';
        const corBorda = verde ? '#4CAF50' : '#FFD54F';
        conteudo += `
        <div style="background-color: #FFFEF2; color: #5D4037; padding: 8px; border-radius: 6px; margin: 6px 0; font-size: 12px;">
            <strong>‚òÄÔ∏è Grupo ${manha}</strong><br><small>${membrosManha}</small>
        </div>
        <div style="background-color: #E3F2FD; color: #1565C0; padding: 8px; border-radius: 6px; margin: 6px 0; font-size: 12px;">
            <strong>üåô Grupo ${noite}</strong><br><small>${membrosNoite}</small>
        </div>
        `;
        const tipoDia = verde ? 'üü¢ B/C Trabalham | A/D Folgam' : 'üü° A/D Trabalham | B/C Folgam';
        conteudo += `<div style="font-size: 10px; color: #666; margin-top: 5px;">${tipoDia}</div>`;
        const ehDiaUtil = diaSemana >= 1 && diaSemana <= 5;
        if (ehDiaUtil) {
            const membros5x2Diurno = formatarMembros(getMembros('5x2', 'diurno'));
            conteudo += `
                <div style="background-color: #FFF3E0; color: #EF6C00; padding: 6px; border-radius: 4px; margin: 4px 0; font-size: 11px;">
                    <strong>üïó 5x2 Diurno</strong><br><small>${membros5x2Diurno}</small>
                </div>
            `;
            const membros5x2Noturno = formatarMembros(getMembros('5x2', 'noturno'));
            conteudo += `
                <div style="background-color: #E1F5FE; color: #0277BD; padding: 6px; border-radius: 4px; margin: 4px 0; font-size: 11px;">
                    <strong>üåô 5x2 Noturno</strong><br><small>${membros5x2Noturno}</small>
                </div>
            `;
            const membrosPrev = formatarMembros(getMembros('PREV', 'noturno'));
            conteudo += `
                <div style="background-color: #FCE4EC; color: #C2185B; padding: 6px; border-radius: 4px; margin: 4px 0; font-size: 11px;">
                    <strong>üõ°Ô∏è Preventiva</strong><br><small>${membrosPrev}</small>
                </div>
            `;
        }
        return `
            <div style="border: 2px solid ${corBorda}; border-radius: 8px; padding: 12px; background: ${corFundo}; min-height: 140px; font-family: 'Segoe UI', sans-serif;">
                ${conteudo}
            </div>
        `;
    }
    function atualizarCalendarioPlantao() {
        const input = document.getElementById('mes-plantao');
        const [anoStr, mesStr] = input.value.split('-');
        const ano = parseInt(anoStr);
        const mes = parseInt(mesStr) - 1;
        const container = document.getElementById('calendario-plantao');
        const cabecalho = Array.from(container.children).slice(0, 7);
        while (container.children.length > 7) {
            container.removeChild(container.lastChild);
        }
        const data = new Date(ano, mes, 1);
        const diasNoMes = new Date(ano, mes + 1, 0).getDate();
        const inicioSemana = data.getDay();
        for (let i = 0; i < inicioSemana; i++) {
            container.appendChild(document.createElement('div'));
        }
        for (let dia = 1; dia <= diasNoMes; dia++) {
            const div = document.createElement('div');
            div.innerHTML = gerarDiaPlantao(dia, mes, ano);
            container.appendChild(div);
        }
    }
    function mudarMesPlantao(delta) {
        const input = document.getElementById('mes-plantao');
        let [ano, mes] = input.value.split('-').map(Number);
        mes += delta;
        if (mes > 12) { mes = 1; ano++; }
        if (mes < 1) { mes = 12; ano--; }
        input.value = `${ano}-${String(mes).padStart(2, '0')}`;
        atualizarCalendarioPlantao();
    }
    function plantaoHoje() {
        const hoje = new Date();
        const mes = hoje.getMonth() + 1;
        const ano = hoje.getFullYear();
        const input = document.getElementById('mes-plantao');
        if (input) {
            input.value = `${ano}-${String(mes).padStart(2, '0')}`;
            atualizarCalendarioPlantao();
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        const navItemPlantao = document.querySelector('.nav-item[onclick*="plantao"]');
        if (navItemPlantao) {
            navItemPlantao.addEventListener('click', function() {
                setTimeout(() => {
                    atualizarCalendarioPlantao();
                    console.log("üìÖ Calend√°rio do Plant√£o atualizado!");
                }, 100);
            });
        }
        if (document.getElementById('page-plantao').classList.contains('active')) {
            atualizarCalendarioPlantao();
        }
    });

    console.log("üéØ JavaScript carregado com sucesso!");
    // Vari√°veis globais para armazenar os dados carregados
let projetoVLTData = null;
let baseCadastroData = null;
let currentSelectedItem = null;

// Fun√ß√£o para mostrar a aba do cat√°logo
function showCatalogoPage() {
    console.log("Carregando aba Cat√°logo...");
    
    // Verifica se os dados j√° foram carregados
    if (!baseCadastroData) {
        // Mostra indicador de carregamento
        document.getElementById('materiaisGrid').innerHTML = `
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Carregando base de materiais...</span>
            </div>
        `;
        
        // Carrega apenas os dados da base de cadastro
        loadBaseCadastroData().then(() => {
            // Ap√≥s carregar, renderiza os materiais
            renderMateriais();
        }).catch(error => {
            console.error("Erro ao carregar dados:", error);
            document.getElementById('materiaisGrid').innerHTML = `
                <div class="loading-spinner">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Erro ao carregar dados: ${error.message}</span>
                </div>
            `;
        });
    } else {
        // Se os dados j√° foram carregados, apenas renderiza
        renderMateriais();
    }
}

// Fun√ß√£o para carregar os dados do projeto VLT
// Fun√ß√£o para carregar os dados do projeto VLT (vers√£o alternativa)
// Fun√ß√£o para carregar os dados do projeto VLT


// Fun√ß√£o para carregar os dados da base de cadastro
function loadBaseCadastroData() {
    return new Promise((resolve, reject) => {
        // URL do arquivo no GitHub - substitua USERNAME e REPO pelos seus dados
        const url = 'https://raw.githubusercontent.com/B33m0r3/MRO_REG/main/VT_2025.07_BASECADASTRO.TXT';
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                return response.text();
            })
            .then(text => {
                try {
                    // Processa o texto para extrair o JSON
                    // O formato do arquivo √© {filename:[json_data]}
                    const match = text.match(/\{[\s\S]*\}/);
                    if (!match) {
                        throw new Error("Formato de arquivo inv√°lido");
                    }
                    
                    // Remove o nome do arquivo e extrai apenas o JSON
                    const jsonStr = text.replace(/^\{[^:]+:/, '{').replace(/\}$/, '}');
                    baseCadastroData = JSON.parse(jsonStr);
                    
                    console.log("Dados da base de cadastro carregados:", baseCadastroData);
                    resolve();
                } catch (parseError) {
                    console.error("Erro ao processar dados da base:", parseError);
                    reject(new Error("Formato de dados da base inv√°lido"));
                }
            })
            .catch(error => {
                console.error("Erro ao carregar arquivo da base:", error);
                reject(error);
            });
    });
}


// Fun√ß√£o recursiva para criar os elementos da √°rvore
function createTreeElement(node) {
    const li = document.createElement('li');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'tree-item';
    itemDiv.onclick = () => selectTreeItem(itemDiv, node);

    // Toggle para expandir/colapsar
    if (node.children && node.children.length > 0) {
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'toggle-btn';
        toggleBtn.textContent = '+';
        toggleBtn.onclick = (e) => {
            e.stopPropagation();
            const childrenUl = li.querySelector('ul');
            if (childrenUl) {
                const isHidden = childrenUl.style.display === 'none';
                childrenUl.style.display = isHidden ? 'block' : 'none';
                toggleBtn.textContent = isHidden ? '-' : '+';
            }
        };
        itemDiv.appendChild(toggleBtn);
    } else {
        const placeholder = document.createElement('span');
        placeholder.className = 'toggle-placeholder';
        itemDiv.appendChild(placeholder);
    }

    // Nome do item
    const nameSpan = document.createElement('span');
    nameSpan.className = 'item-originalname';
    nameSpan.textContent = node.originalname || node.name;
    itemDiv.appendChild(nameSpan);
    
    // Bot√£o para visualizar detalhes
    const viewBtn = document.createElement('button');
    viewBtn.className = 'view-btn';
    viewBtn.textContent = 'Ver';
    viewBtn.onclick = (e) => {
        e.stopPropagation();
        showItemDetails(node);
    };
    itemDiv.appendChild(viewBtn);

    li.appendChild(itemDiv);

    // Adiciona filhos recursivamente
    if (node.children && node.children.length > 0) {
        const ul = document.createElement('ul');
        ul.style.display = 'none'; // Come√ßa colapsado
        node.children.forEach(child => {
            ul.appendChild(createTreeElement(child));
        });
        li.appendChild(ul);
    }

    return li;
}

// Fun√ß√£o para renderizar a grade de materiais
function renderMateriais() {
    const gridContainer = document.getElementById('materiaisGrid');
    if (!gridContainer) return;

    gridContainer.innerHTML = ''; // Limpa o "Carregando..."

    if (!baseCadastroData || baseCadastroData.length === 0) {
        gridContainer.innerHTML = '<p style="padding: 20px; color: var(--danger);">Erro: Base de cadastro n√£o encontrada.</p>';
        return;
    }

    baseCadastroData.forEach(material => {
        const card = document.createElement('div');
        card.className = 'material-card';
        card.onclick = () => showMaterialDetails(material);

        const title = document.createElement('h4');
        title.textContent = material["Texto breve de material"];

        const id = document.createElement('p');
        id.innerHTML = `<span class="material-id">C√≥digo:</span> ${material.Material}`;

        const description = document.createElement('p');
        description.textContent = material["Texto Longo"] ? material["Texto Longo"].substring(0, 100) + '...' : 'Sem descri√ß√£o longa.';

        card.appendChild(title);
        card.appendChild(id);
        card.appendChild(description);
        gridContainer.appendChild(card);
    });
}

// Fun√ß√£o para selecionar um item na √°rvore
function selectTreeItem(element, node) {
    // Remove sele√ß√£o anterior
    document.querySelectorAll('.tree-item').forEach(item => item.classList.remove('selected'));
    // Adiciona sele√ß√£o ao item clicado
    element.classList.add('selected');
    currentSelectedItem = node;
}

// Fun√ß√£o para mostrar detalhes do item (da √°rvore ou material)
function showItemDetails(item) {
    const modal = document.getElementById('itemDetailsModal');
    const title = document.getElementById('modalTitle');
    const content = document.getElementById('modalTabContent');

    title.textContent = item.originalname || item["Texto breve de material"];

    // Aba 'Detalhes'
    const detailsHTML = `
        <p><strong>Fabricante:</strong> ${item.fabricanteFornecedor || 'N/A'}</p>
        <p><strong>Refer√™ncia Comercial:</strong> ${item.referenciaComercial || 'N/A'}</p>
        <p><strong>C√≥digo SAP:</strong> ${item.codigoSap || item.Material || 'N/A'}</p>
        <p><strong>Quantidade:</strong> ${item.qtd || item["Utiliza√ß√£o livre"] || 'N/A'}</p>
        <p><strong>Descri√ß√£o:</strong> ${item.description || item["Texto Longo"] || 'N/A'}</p>
        <p><strong>Dep√≥sito:</strong> ${item.Dep√≥sito || 'N/A'}</p>
        <p><strong>Centro:</strong> ${item.Centro || 'N/A'}</p>
    `;
    
    // Aba 'Imagens'
    const images = [item.imageUrl1, item.imageUrl2, item.imageUrl3, item["Image URL"]].filter(url => url);
    const imagesHTML = `
        <div class="image-gallery">
            ${images.length > 0 ? images.map(url => `<img src="${url}" alt="Imagem do componente" onerror="this.src='https://picsum.photos/seed/error/300/200.jpg'">`).join('') : '<p>Nenhuma imagem dispon√≠vel.</p>'}
        </div>
    `;

    // Configura o conte√∫do inicial para a aba de detalhes
    content.innerHTML = detailsHTML;
    modal.classList.add('show');

    // Adiciona manipulador para as abas do modal
    document.querySelectorAll('.modal-tab-btn').forEach(btn => {
        btn.onclick = (e) => {
            document.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            if (e.target.textContent.includes('Detalhes')) {
                content.innerHTML = detailsHTML;
            } else if (e.target.textContent.includes('Imagens')) {
                content.innerHTML = imagesHTML;
            }
        };
    });
}

// Fun√ß√£o para mostrar detalhes do material
function showMaterialDetails(material) {
    showItemDetails(material);
}

// Fun√ß√£o para fechar o modal
function closeModal() {
    document.getElementById('itemDetailsModal').classList.remove('show');
}

// Fun√ß√µes de busca


function searchMateriais() {
    const input = document.getElementById('materialSearchInput');
    const filter = input.value.toLowerCase();
    const cards = document.querySelectorAll('.material-card');

    cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        if (text.includes(filter)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}


function clearMaterialSearch() {
    document.getElementById('materialSearchInput').value = '';
    searchMateriais();
}

// Adicione um evento para fechar o modal ao clicar fora dele
window.onclick = function(event) {
    const modal = document.getElementById('itemDetailsModal');
    if (event.target === modal) {
        closeModal();
    }
}
/* ===================================================================
   C√ìDIGO CORRIGIDO PARA A ABA CAT√ÅLOGO (VERS√ÉO FINAL)
   =================================================================== */

// URL CORRETA para o arquivo JSON bruto (raw) no GitHub
const PROJECT_DATA_URL = 'https://raw.githubusercontent.com/B33m0r3/MRO_REG/main/1MRO_FROTA.CITADIS402.json';

// Vari√°vel global para armazenar a estrutura da √°rvore j√° processada
let projectTreeData = [];

// Fun√ß√£o principal que √© chamada ao abrir a aba Cat√°logo
function loadProjectTree() {
    const treeContainer = document.querySelector('.tree-container');
    if (!treeContainer) return;

    // 1. Mostrar indicador de carregamento
    treeContainer.innerHTML = `
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Carregando e processando estrutura do projeto...</p>
        </div>
    `;

    // 2. Buscar os dados do arquivo JSON bruto
    fetch(PROJECT_DATA_URL)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro HTTP! Status: ${response.status}. Verifique a URL do arquivo.`);
            }
            return response.json();
        })
        .then(flatData => {
            // 3. Transformar a lista plana em uma estrutura de √°rvore
            projectTreeData = buildTreeFromFlatData(flatData);
            
            // Limpa o indicador de carregamento
            treeContainer.innerHTML = '';

            if (projectTreeData.length > 0) {
                // 4. Renderizar a √°rvore no primeiro n√≠vel
                renderTreeLevel(projectTreeData, treeContainer);
            } else {
                treeContainer.innerHTML = '<p style="padding: 20px; color: #888;">N√£o foi poss√≠vel construir a √°rvore a partir dos dados.</p>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar ou processar os dados do projeto:', error);
            treeContainer.innerHTML = `
                <div class="fallback-container">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--danger); margin-bottom: 15px;"></i>
                    <p class="fallback-message"><strong>Erro: Dados do projeto n√£o encontrados.</strong></p>
                    <p class="fallback-message">N√£o foi poss√≠vel carregar o arquivo da URL: <br><code>${PROJECT_DATA_URL}</code></p>
                    <p style="font-size: 12px; color: #999; margin-top: 15px;">Detalhes do erro: ${error.message}</p>
                </div>
            `;
        });
}

/**
 * Transforma uma lista plana (do seu JSON) em uma estrutura de √°rvore hier√°rquica.
 * @param {Array} flatData - O array de objetos vindo do JSON.
 * @returns {Array} - A estrutura de √°rvore pronta para ser renderizada.
 */
function buildTreeFromFlatData(flatData) {
    const tree = [];
    const map = new Map();

    // Primeira passagem: cria todos os n√≥s e os coloca em um mapa para acesso r√°pido
    flatData.forEach(item => {
        // N√≥s s√£o criados para cada n√≠vel que n√£o √© nulo
        const levels = [
            { name: item.NIVEL1, level: 1 },
            { name: item.NIVEL2, level: 2 },
            { name: item.NIVEL3, level: 3 },
            { name: item.NIVEL4, level: 4 },
            { name: item.NIVEL5, level: 5 },
            { name: item.DESCRICAO, level: 6, id: item.CODIGO } // O √∫ltimo n√≠vel √© a descri√ß√£o com o c√≥digo
        ];

        let currentPath = '';
        levels.forEach(lvl => {
            if (lvl.name) {
                const id = currentPath + lvl.name;
                if (!map.has(id)) {
                    map.set(id, {
                        id: id,
                        name: lvl.name,
                        children: [],
                        isLeaf: lvl.level === 6 // Marca se √© o n√≥ final (folha)
                    });
                }
                currentPath = id + ' > ';
            }
        });
    });

    // Segunda passagem: constr√≥i a hierarquia ligando os pais aos filhos
    map.forEach(node => {
        // Encontra o pai removendo o √∫ltimo componente do ID
        const parentId = node.id.substring(0, node.id.lastIndexOf(' > '));
        if (parentId && map.has(parentId)) {
            map.get(parentId).children.push(node);
        } else if (!parentId) {
            // Se n√£o tem pai, √© um n√≥ raiz
            tree.push(node);
        }
    });

    return tree;
}

// Fun√ß√£o para renderizar um n√≠vel da √°rvore (esta fun√ß√£o continua a mesma)
function renderTreeLevel(items, containerElement) {
    const ul = document.createElement('ul');
    items.forEach(item => {
        const li = document.createElement('li');
        li.dataset.id = item.id;

        const itemDiv = document.createElement('div');
        itemDiv.classList.add('tree-item');

        // Adiciona o bot√£o de expandir/recolher se houver filhos
        if (item.children && item.children.length > 0) {
            const toggleBtn = document.createElement('span');
            toggleBtn.classList.add('toggle-btn');
            toggleBtn.textContent = '+';
            toggleBtn.onclick = (e) => {
                e.stopPropagation();
                toggleNode(li, toggleBtn, item.children);
            };
            itemDiv.appendChild(toggleBtn);
        } else {
            const placeholder = document.createElement('span');
            placeholder.classList.add('toggle-placeholder');
            itemDiv.appendChild(placeholder);
        }

        // Adiciona o nome do item. Se for folha, adiciona um link para visualizar.
        const itemName = document.createElement('span');
        if(item.isLeaf) {
            // Se for um item final (folha), podemos adicionar um link ou bot√£o para ver detalhes
            itemName.innerHTML = `<i class="fas fa-cog" style="color: var(--primary); margin-right: 8px;"></i>${item.name}`;
        } else {
            itemName.textContent = item.name;
        }
        itemDiv.appendChild(itemName);
        
        li.appendChild(itemDiv);
        ul.appendChild(li);
    });
    containerElement.appendChild(ul);
}

// Fun√ß√£o para expandir ou recolher um n√≥ da √°rvore (continua a mesma)
function toggleNode(liElement, buttonElement, childrenData) {
    const childUl = liElement.querySelector(':scope > ul');

    if (childUl) {
        liElement.removeChild(childUl);
        buttonElement.textContent = '+';
    } else {
        const newUl = document.createElement('ul');
        renderTreeLevel(childrenData, newUl);
        liElement.appendChild(newUl);
        buttonElement.textContent = '-';
    }
}


</script>
</body>
</html>
